"use strict";(self.webpackChunksite=self.webpackChunksite||[]).push([[1170],{6047:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"security/csrf-protection","title":"CSRF Protection","description":"Configure Cross-Site Request Forgery (CSRF) protection for Spring Boot Admin while allowing client registration.","source":"@site/docs/05-security/30-csrf-protection.md","sourceDirName":"05-security","slug":"/security/csrf-protection","permalink":"/4.0.0/docs/security/csrf-protection","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":30,"frontMatter":{"sidebar_position":30,"sidebar_custom_props":{"icon":"shield"}},"sidebar":"sidebar","previous":{"title":"Actuator Security","permalink":"/4.0.0/docs/security/actuator-security"},"next":{"title":"Customization","permalink":"/4.0.0/docs/customization/"}}');var s=t(4848),i=t(8453);const o={sidebar_position:30,sidebar_custom_props:{icon:"shield"}},a="CSRF Protection",c={},l=[{value:"Overview",id:"overview",level:2},{value:"Why CSRF Protection?",id:"why-csrf-protection",level:2},{value:"CSRF Configuration",id:"csrf-configuration",level:2},{value:"Complete Example",id:"complete-example",level:3},{value:"Custom CSRF Filter",id:"custom-csrf-filter",level:2},{value:"How CSRF Works in Admin Server",id:"how-csrf-works-in-admin-server",level:2},{value:"1. User Opens Admin UI",id:"1-user-opens-admin-ui",level:3},{value:"2. JavaScript Makes Request",id:"2-javascript-makes-request",level:3},{value:"3. Spring Security Validates Token",id:"3-spring-security-validates-token",level:3},{value:"4. Client Registration (Exempted)",id:"4-client-registration-exempted",level:3},{value:"Cookie vs Session Token Repository",id:"cookie-vs-session-token-repository",level:2},{value:"Cookie-Based (Recommended for SPA)",id:"cookie-based-recommended-for-spa",level:3},{value:"Session-Based (Default)",id:"session-based-default",level:3},{value:"Exempted Endpoints",id:"exempted-endpoints",level:2},{value:"Client Registration",id:"client-registration",level:3},{value:"Actuator Endpoints",id:"actuator-endpoints",level:3},{value:"Notification Endpoints",id:"notification-endpoints",level:3},{value:"Context Path Support",id:"context-path-support",level:2},{value:"Testing CSRF Protection",id:"testing-csrf-protection",level:2},{value:"Test UI Request (Requires Token)",id:"test-ui-request-requires-token",level:3},{value:"Test Client Registration (Exempted)",id:"test-client-registration-exempted",level:3},{value:"Test Actuator (Exempted)",id:"test-actuator-exempted",level:3},{value:"Disable CSRF (Not Recommended)",id:"disable-csrf-not-recommended",level:2},{value:"SameSite Cookie Attribute",id:"samesite-cookie-attribute",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Issue: 403 Forbidden on all requests",id:"issue-403-forbidden-on-all-requests",level:3},{value:"Issue: Client registration fails with 403",id:"issue-client-registration-fails-with-403",level:3},{value:"Issue: Token cookie not accessible to JavaScript",id:"issue-token-cookie-not-accessible-to-javascript",level:3},{value:"Issue: Token changes on every request",id:"issue-token-changes-on-every-request",level:3},{value:"Issue: CSRF protection not working with context path",id:"issue-csrf-protection-not-working-with-context-path",level:3},{value:"Advanced Configuration",id:"advanced-configuration",level:2},{value:"Custom Token Header/Cookie Names",id:"custom-token-headercookie-names",level:3},{value:"Conditional CSRF Protection",id:"conditional-csrf-protection",level:3},{value:"Multiple Security Filter Chains",id:"multiple-security-filter-chains",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"Complete Working Example",id:"complete-working-example",level:2},{value:"See Also",id:"see-also",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"csrf-protection",children:"CSRF Protection"})}),"\n",(0,s.jsx)(n.p,{children:"Configure Cross-Site Request Forgery (CSRF) protection for Spring Boot Admin while allowing client registration."}),"\n",(0,s.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsx)(n.p,{children:"Spring Boot Admin Server needs CSRF protection for the web UI, but must exempt certain endpoints:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"/instances"})," - Client registration endpoint (POST)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"/instances/*"})," - Client deregistration endpoint (DELETE)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"/actuator/**"})," - Admin Server's own actuator endpoints"]}),"\n"]}),"\n",(0,s.jsx)(n.mermaid,{value:'graph TB\n    A["**Browser Admin UI**<br/>\u2022 Sends CSRF token in requests<br/>\u2022 Token stored in XSRF-TOKEN cookie<br/>\u2022 Angular/React reads cookie and sends X-XSRF-TOKEN header"] --\x3e B["**Spring Boot Admin Server**<br/>\u2022 Validates CSRF token for UI requests<br/>\u2022 Exempts /instances endpoint client registration<br/>\u2022 Exempts /actuator/** health checks"]\n    C["**Client Application**<br/>\u2022 Registers without CSRF token<br/>\u2022 Uses HTTP POST to /instances"] --\x3e B'}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"why-csrf-protection",children:"Why CSRF Protection?"}),"\n",(0,s.jsx)(n.p,{children:"CSRF attacks trick authenticated users into performing unwanted actions:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"User logs into Admin Server in their browser"}),"\n",(0,s.jsx)(n.li,{children:"User visits malicious website"}),"\n",(0,s.jsx)(n.li,{children:"Malicious website sends request to Admin Server using user's session"}),"\n",(0,s.jsx)(n.li,{children:"Without CSRF protection, the request succeeds"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"CSRF tokens prevent this"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Each request requires a unique token"}),"\n",(0,s.jsx)(n.li,{children:"Tokens are tied to the user's session"}),"\n",(0,s.jsx)(n.li,{children:"Malicious websites cannot obtain valid tokens"}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"csrf-configuration",children:"CSRF Configuration"}),"\n",(0,s.jsx)(n.h3,{id:"complete-example",children:"Complete Example"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'package com.example.admin;\n\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.security.config.annotation.web.builders.HttpSecurity;\nimport org.springframework.security.web.SecurityFilterChain;\nimport org.springframework.security.web.authentication.www.BasicAuthenticationFilter;\nimport org.springframework.security.web.csrf.CookieCsrfTokenRepository;\nimport org.springframework.security.web.csrf.CsrfTokenRequestAttributeHandler;\nimport org.springframework.security.web.servlet.util.matcher.PathPatternRequestMatcher;\n\nimport de.codecentric.boot.admin.server.config.AdminServerProperties;\n\nimport static org.springframework.http.HttpMethod.DELETE;\nimport static org.springframework.http.HttpMethod.POST;\n\n@Configuration\npublic class SecurityConfig {\n\n    private final AdminServerProperties adminServer;\n\n    public SecurityConfig(AdminServerProperties adminServer) {\n        this.adminServer = adminServer;\n    }\n\n    @Bean\n    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {\n        http\n            .authorizeHttpRequests(auth -> auth\n                .requestMatchers(PathPatternRequestMatcher.withDefaults()\n                    .matcher(adminServer.path("/assets/**")))\n                .permitAll()\n                .requestMatchers(PathPatternRequestMatcher.withDefaults()\n                    .matcher(adminServer.path("/login")))\n                .permitAll()\n                .anyRequest().authenticated()\n            )\n            .formLogin(formLogin -> formLogin\n                .loginPage(adminServer.path("/login"))\n            )\n            .httpBasic(Customizer.withDefaults());\n\n        // Custom CSRF filter to expose token to JavaScript\n        http.addFilterAfter(new CustomCsrfFilter(), BasicAuthenticationFilter.class);\n\n        // CSRF configuration\n        http.csrf(csrf -> csrf\n            // Use cookie-based token repository (accessible to JavaScript)\n            .csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse())\n            // Use attribute-based token handler\n            .csrfTokenRequestHandler(new CsrfTokenRequestAttributeHandler())\n            // Exempt specific endpoints\n            .ignoringRequestMatchers(\n                // Client registration\n                PathPatternRequestMatcher.withDefaults()\n                    .matcher(POST, adminServer.path("/instances")),\n                // Client deregistration\n                PathPatternRequestMatcher.withDefaults()\n                    .matcher(DELETE, adminServer.path("/instances/*")),\n                // Notification endpoints\n                PathPatternRequestMatcher.withDefaults()\n                    .matcher(POST, adminServer.path("/notifications/**")),\n                PathPatternRequestMatcher.withDefaults()\n                    .matcher(DELETE, adminServer.path("/notifications/**")),\n                // Admin Server\'s own actuator\n                PathPatternRequestMatcher.withDefaults()\n                    .matcher(adminServer.path("/actuator/**"))\n            )\n        );\n\n        return http.build();\n    }\n}\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"custom-csrf-filter",children:"Custom CSRF Filter"}),"\n",(0,s.jsx)(n.p,{children:"The Admin UI (JavaScript) needs access to the CSRF token. Create a filter to expose it:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'package com.example.admin;\n\nimport java.io.IOException;\n\nimport jakarta.servlet.FilterChain;\nimport jakarta.servlet.ServletException;\nimport jakarta.servlet.http.Cookie;\nimport jakarta.servlet.http.HttpServletRequest;\nimport jakarta.servlet.http.HttpServletResponse;\nimport org.springframework.security.web.csrf.CsrfToken;\nimport org.springframework.web.filter.OncePerRequestFilter;\nimport org.springframework.web.util.WebUtils;\n\npublic class CustomCsrfFilter extends OncePerRequestFilter {\n\n    public static final String CSRF_COOKIE_NAME = "XSRF-TOKEN";\n\n    @Override\n    protected void doFilterInternal(HttpServletRequest request,\n                                    HttpServletResponse response,\n                                    FilterChain filterChain)\n            throws ServletException, IOException {\n\n        // Get CSRF token from request attributes\n        CsrfToken csrf = (CsrfToken) request.getAttribute(CsrfToken.class.getName());\n\n        if (csrf != null) {\n            Cookie cookie = WebUtils.getCookie(request, CSRF_COOKIE_NAME);\n            String token = csrf.getToken();\n\n            // Set cookie if not present or token changed\n            if (cookie == null || token != null && !token.equals(cookie.getValue())) {\n                cookie = new Cookie(CSRF_COOKIE_NAME, token);\n                cookie.setPath("/");\n                response.addCookie(cookie);\n            }\n        }\n\n        filterChain.doFilter(request, response);\n    }\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"What this does"}),":"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Extracts CSRF token from Spring Security"}),"\n",(0,s.jsxs)(n.li,{children:["Stores it in a cookie named ",(0,s.jsx)(n.code,{children:"XSRF-TOKEN"})]}),"\n",(0,s.jsxs)(n.li,{children:["Cookie is ",(0,s.jsx)(n.strong,{children:"not"})," HTTP-only (JavaScript can read it)"]}),"\n",(0,s.jsx)(n.li,{children:"Admin UI reads cookie and includes token in requests"}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"how-csrf-works-in-admin-server",children:"How CSRF Works in Admin Server"}),"\n",(0,s.jsx)(n.h3,{id:"1-user-opens-admin-ui",children:"1. User Opens Admin UI"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"GET / HTTP/1.1\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Response"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"HTTP/1.1 200 OK\nSet-Cookie: XSRF-TOKEN=abc123; Path=/\nSet-Cookie: JSESSIONID=xyz789; Path=/; HttpOnly\n\n<!DOCTYPE html>\n<html>...</html>\n"})}),"\n",(0,s.jsx)(n.h3,{id:"2-javascript-makes-request",children:"2. JavaScript Makes Request"}),"\n",(0,s.jsxs)(n.p,{children:["Admin UI JavaScript reads ",(0,s.jsx)(n.code,{children:"XSRF-TOKEN"})," cookie and sends it in header:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"fetch('/instances/123/actuator/info', {\n  method: 'GET',\n  headers: {\n    'X-XSRF-TOKEN': 'abc123'  // From cookie\n  },\n  credentials: 'same-origin'\n})\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"HTTP Request"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"GET /instances/123/actuator/info HTTP/1.1\nX-XSRF-TOKEN: abc123\nCookie: XSRF-TOKEN=abc123; JSESSIONID=xyz789\n"})}),"\n",(0,s.jsx)(n.h3,{id:"3-spring-security-validates-token",children:"3. Spring Security Validates Token"}),"\n",(0,s.jsx)(n.p,{children:"Spring Security compares:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Token from ",(0,s.jsx)(n.code,{children:"X-XSRF-TOKEN"})," header"]}),"\n",(0,s.jsxs)(n.li,{children:["Token from ",(0,s.jsx)(n.code,{children:"XSRF-TOKEN"})," cookie"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"If they match, request is allowed."}),"\n",(0,s.jsx)(n.h3,{id:"4-client-registration-exempted",children:"4. Client Registration (Exempted)"}),"\n",(0,s.jsxs)(n.p,{children:["Client applications register ",(0,s.jsx)(n.strong,{children:"without"})," CSRF token:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'POST /instances HTTP/1.1\nContent-Type: application/json\n\n{\n  "name": "my-service",\n  "healthUrl": "http://localhost:8081/actuator/health"\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["This works because ",(0,s.jsx)(n.code,{children:"/instances"})," is in ",(0,s.jsx)(n.code,{children:"ignoringRequestMatchers"}),"."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"cookie-vs-session-token-repository",children:"Cookie vs Session Token Repository"}),"\n",(0,s.jsx)(n.h3,{id:"cookie-based-recommended-for-spa",children:"Cookie-Based (Recommended for SPA)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:".csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse())\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Pros"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"JavaScript can read token from cookie"}),"\n",(0,s.jsx)(n.li,{children:"Works with Single Page Applications (SPA)"}),"\n",(0,s.jsx)(n.li,{children:"Stateless (no server-side session storage)"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Cons"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Cookie not HTTP-only (accessible to JavaScript)"}),"\n",(0,s.jsx)(n.li,{children:"Requires custom filter to set cookie"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"session-based-default",children:"Session-Based (Default)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:".csrfTokenRepository(new HttpSessionCsrfTokenRepository())\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Pros"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"More secure (token not exposed to JavaScript)"}),"\n",(0,s.jsx)(n.li,{children:"Simpler configuration"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Cons"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Requires server-side session"}),"\n",(0,s.jsx)(n.li,{children:"Harder to use with SPA frameworks"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Spring Boot Admin requires cookie-based"})," because the UI is a JavaScript SPA."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"exempted-endpoints",children:"Exempted Endpoints"}),"\n",(0,s.jsx)(n.h3,{id:"client-registration",children:"Client Registration"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'.ignoringRequestMatchers(\n    PathPatternRequestMatcher.withDefaults()\n        .matcher(POST, adminServer.path("/instances")),\n    PathPatternRequestMatcher.withDefaults()\n        .matcher(DELETE, adminServer.path("/instances/*"))\n)\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Why?"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Client applications don't have CSRF tokens"}),"\n",(0,s.jsx)(n.li,{children:"They register/deregister via simple HTTP POST/DELETE"}),"\n",(0,s.jsx)(n.li,{children:"Not vulnerable to CSRF (no browser session involved)"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"actuator-endpoints",children:"Actuator Endpoints"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'.ignoringRequestMatchers(\n    PathPatternRequestMatcher.withDefaults()\n        .matcher(adminServer.path("/actuator/**"))\n)\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Why?"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Admin Server's own health checks"}),"\n",(0,s.jsx)(n.li,{children:"Load balancers, monitoring tools access these"}),"\n",(0,s.jsx)(n.li,{children:"No CSRF risk (stateless, no session)"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"notification-endpoints",children:"Notification Endpoints"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'.ignoringRequestMatchers(\n    PathPatternRequestMatcher.withDefaults()\n        .matcher(POST, adminServer.path("/notifications/**")),\n    PathPatternRequestMatcher.withDefaults()\n        .matcher(DELETE, adminServer.path("/notifications/**"))\n)\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Why?"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Webhook endpoints from external services (Slack, Teams, etc.)"}),"\n",(0,s.jsx)(n.li,{children:"Cannot provide CSRF tokens"}),"\n",(0,s.jsx)(n.li,{children:"Authenticated via other means (webhook secrets)"}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"context-path-support",children:"Context Path Support"}),"\n",(0,s.jsx)(n.p,{children:"If using a custom context path:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"spring:\n  boot:\n    admin:\n      context-path: /admin\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Use ",(0,s.jsx)(n.code,{children:"adminServer.path()"})," to include context path automatically:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'PathPatternRequestMatcher.withDefaults()\n    .matcher(POST, adminServer.path("/instances"))\n'})}),"\n",(0,s.jsxs)(n.p,{children:["This becomes ",(0,s.jsx)(n.code,{children:"/admin/instances"})," automatically."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"testing-csrf-protection",children:"Testing CSRF Protection"}),"\n",(0,s.jsx)(n.h3,{id:"test-ui-request-requires-token",children:"Test UI Request (Requires Token)"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Without token"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'curl -X POST http://localhost:8080/applications/my-app/restart \\\n  -H "Cookie: JSESSIONID=abc123"\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Response"}),": ",(0,s.jsx)(n.code,{children:"403 Forbidden"})]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"With token"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'curl -X POST http://localhost:8080/applications/my-app/restart \\\n  -H "Cookie: JSESSIONID=abc123; XSRF-TOKEN=def456" \\\n  -H "X-XSRF-TOKEN: def456"\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Response"}),": ",(0,s.jsx)(n.code,{children:"200 OK"})]}),"\n",(0,s.jsx)(n.h3,{id:"test-client-registration-exempted",children:"Test Client Registration (Exempted)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'curl -X POST http://localhost:8080/instances \\\n  -H "Content-Type: application/json" \\\n  -d \'{\n    "name": "test-service",\n    "healthUrl": "http://localhost:8081/actuator/health"\n  }\'\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Response"}),": ",(0,s.jsx)(n.code,{children:"201 Created"})," (no CSRF token needed)"]}),"\n",(0,s.jsx)(n.h3,{id:"test-actuator-exempted",children:"Test Actuator (Exempted)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"curl http://localhost:8080/actuator/health\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Response"}),": ",(0,s.jsx)(n.code,{children:"200 OK"})," (no CSRF token needed)"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"disable-csrf-not-recommended",children:"Disable CSRF (Not Recommended)"}),"\n",(0,s.jsx)(n.p,{children:"For development/testing only:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'@Bean\n@Profile("dev")\npublic SecurityFilterChain filterChain(HttpSecurity http) throws Exception {\n    http\n        .authorizeHttpRequests(/* ... */)\n        .csrf(csrf -> csrf.disable());  // Disable CSRF\n\n    return http.build();\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Only disable CSRF for development and testing."})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"samesite-cookie-attribute",children:"SameSite Cookie Attribute"}),"\n",(0,s.jsx)(n.p,{children:"Enhance CSRF protection with SameSite cookies:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"server:\n  servlet:\n    session:\n      cookie:\n        same-site: strict\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Options"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"strict"}),": Cookie only sent for same-site requests (most secure)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"lax"}),": Cookie sent for top-level navigation (default)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"none"}),": Cookie sent for all requests (requires ",(0,s.jsx)(n.code,{children:"secure=true"}),")"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Recommendation"}),": Use ",(0,s.jsx)(n.code,{children:"lax"})," for Admin Server (allows direct navigation)."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,s.jsx)(n.h3,{id:"issue-403-forbidden-on-all-requests",children:"Issue: 403 Forbidden on all requests"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Cause"}),": CSRF token missing or invalid."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Check"}),":"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Cookie is set:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"curl -i http://localhost:8080/\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Should see ",(0,s.jsx)(n.code,{children:"Set-Cookie: XSRF-TOKEN=..."})]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Custom CSRF filter is registered:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:"http.addFilterAfter(new CustomCsrfFilter(), BasicAuthenticationFilter.class)\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsx)(n.p,{children:"Token repository is cookie-based:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:".csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse())\n"})}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"issue-client-registration-fails-with-403",children:"Issue: Client registration fails with 403"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Cause"}),": ",(0,s.jsx)(n.code,{children:"/instances"})," endpoint not exempted from CSRF."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Solution"}),": Add to ",(0,s.jsx)(n.code,{children:"ignoringRequestMatchers"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'.csrf(csrf -> csrf\n    .ignoringRequestMatchers(\n        PathPatternRequestMatcher.withDefaults()\n            .matcher(POST, adminServer.path("/instances")),\n        PathPatternRequestMatcher.withDefaults()\n            .matcher(DELETE, adminServer.path("/instances/*"))\n    )\n)\n'})}),"\n",(0,s.jsx)(n.h3,{id:"issue-token-cookie-not-accessible-to-javascript",children:"Issue: Token cookie not accessible to JavaScript"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Cause"}),": Cookie is HTTP-only."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Solution"}),": Use ",(0,s.jsx)(n.code,{children:"withHttpOnlyFalse()"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:".csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse())\n"})}),"\n",(0,s.jsx)(n.h3,{id:"issue-token-changes-on-every-request",children:"Issue: Token changes on every request"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Expected behavior"}),". Spring Security generates new tokens regularly for security."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"If problematic"}),": Use ",(0,s.jsx)(n.code,{children:"CookieCsrfTokenRepository"})," with custom settings:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'CookieCsrfTokenRepository repository = CookieCsrfTokenRepository.withHttpOnlyFalse();\nrepository.setCookieName("XSRF-TOKEN");\nrepository.setHeaderName("X-XSRF-TOKEN");\n'})}),"\n",(0,s.jsx)(n.h3,{id:"issue-csrf-protection-not-working-with-context-path",children:"Issue: CSRF protection not working with context path"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Cause"}),": Matchers don't include context path."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Solution"}),": Use ",(0,s.jsx)(n.code,{children:"adminServer.path()"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'PathPatternRequestMatcher.withDefaults()\n    .matcher(POST, adminServer.path("/instances"))\n'})}),"\n",(0,s.jsx)(n.p,{children:"Not:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'new AntPathRequestMatcher("/instances", POST.name())\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"advanced-configuration",children:"Advanced Configuration"}),"\n",(0,s.jsx)(n.h3,{id:"custom-token-headercookie-names",children:"Custom Token Header/Cookie Names"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'CookieCsrfTokenRepository repository = new CookieCsrfTokenRepository();\nrepository.setCookieName("MY-CSRF-TOKEN");\nrepository.setHeaderName("X-MY-CSRF-TOKEN");\nrepository.setParameterName("_csrf");\nrepository.setCookieHttpOnly(false);\n\nhttp.csrf(csrf -> csrf\n    .csrfTokenRepository(repository)\n)\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Update ",(0,s.jsx)(n.code,{children:"CustomCsrfFilter"})," accordingly:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'public static final String CSRF_COOKIE_NAME = "MY-CSRF-TOKEN";\n'})}),"\n",(0,s.jsx)(n.h3,{id:"conditional-csrf-protection",children:"Conditional CSRF Protection"}),"\n",(0,s.jsx)(n.p,{children:"Enable CSRF only for browser requests:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'http.csrf(csrf -> csrf\n    .requireCsrfProtectionMatcher(request -> {\n        // Require CSRF for browser requests (non-API)\n        String method = request.getMethod();\n        if ("GET".equals(method) || "HEAD".equals(method) ||\n            "TRACE".equals(method) || "OPTIONS".equals(method)) {\n            return false;  // Safe methods\n        }\n\n        String header = request.getHeader("X-Requested-With");\n        if ("XMLHttpRequest".equals(header)) {\n            return true;  // AJAX requests\n        }\n\n        String accept = request.getHeader("Accept");\n        if (accept != null && accept.contains("application/json")) {\n            return false;  // API clients\n        }\n\n        return true;  // Browser requests\n    })\n)\n'})}),"\n",(0,s.jsx)(n.h3,{id:"multiple-security-filter-chains",children:"Multiple Security Filter Chains"}),"\n",(0,s.jsx)(n.p,{children:"Separate CSRF rules for UI and API:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'@Configuration\npublic class SecurityConfig {\n\n    @Bean\n    @Order(1)\n    public SecurityFilterChain apiFilterChain(HttpSecurity http,\n                                              AdminServerProperties adminServer) throws Exception {\n        http\n            .securityMatcher(adminServer.path("/api/**"))\n            .authorizeHttpRequests(auth -> auth.anyRequest().authenticated())\n            .httpBasic(Customizer.withDefaults())\n            .csrf(csrf -> csrf.disable());  // No CSRF for API\n\n        return http.build();\n    }\n\n    @Bean\n    @Order(2)\n    public SecurityFilterChain uiFilterChain(HttpSecurity http,\n                                             AdminServerProperties adminServer) throws Exception {\n        http\n            .authorizeHttpRequests(auth -> auth.anyRequest().authenticated())\n            .formLogin(/* ... */)\n            .csrf(csrf -> csrf  // CSRF for UI\n                .csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse())\n            );\n\n        return http.build();\n    }\n}\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Always enable CSRF"})," when deploying"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Use cookie-based repository"})," for JavaScript SPAs"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Exempt only necessary endpoints"})," (client registration, actuator)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Use SameSite cookies"})," for additional protection"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Test CSRF protection"})," before deploying"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Use HTTPS"})," to prevent token theft"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Rotate session IDs"})," after login"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Monitor for CSRF attacks"})," in logs"]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"complete-working-example",children:"Complete Working Example"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"SecurityConfig.java"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'package com.example.admin;\n\nimport java.util.UUID;\n\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.security.config.Customizer;\nimport org.springframework.security.config.annotation.web.builders.HttpSecurity;\nimport org.springframework.security.core.userdetails.User;\nimport org.springframework.security.core.userdetails.UserDetails;\nimport org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;\nimport org.springframework.security.crypto.password.PasswordEncoder;\nimport org.springframework.security.provisioning.InMemoryUserDetailsManager;\nimport org.springframework.security.web.SecurityFilterChain;\nimport org.springframework.security.web.authentication.SavedRequestAwareAuthenticationSuccessHandler;\nimport org.springframework.security.web.authentication.www.BasicAuthenticationFilter;\nimport org.springframework.security.web.csrf.CookieCsrfTokenRepository;\nimport org.springframework.security.web.csrf.CsrfTokenRequestAttributeHandler;\nimport org.springframework.security.web.servlet.util.matcher.PathPatternRequestMatcher;\n\nimport de.codecentric.boot.admin.server.config.AdminServerProperties;\n\nimport static org.springframework.http.HttpMethod.DELETE;\nimport static org.springframework.http.HttpMethod.POST;\n\n@Configuration\npublic class SecurityConfig {\n\n    private final AdminServerProperties adminServer;\n\n    public SecurityConfig(AdminServerProperties adminServer) {\n        this.adminServer = adminServer;\n    }\n\n    @Bean\n    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {\n        SavedRequestAwareAuthenticationSuccessHandler successHandler =\n            new SavedRequestAwareAuthenticationSuccessHandler();\n        successHandler.setTargetUrlParameter("redirectTo");\n        successHandler.setDefaultTargetUrl(adminServer.path("/"));\n\n        http\n            .authorizeHttpRequests(auth -> auth\n                .requestMatchers(PathPatternRequestMatcher.withDefaults()\n                    .matcher(adminServer.path("/assets/**")))\n                .permitAll()\n                .requestMatchers(PathPatternRequestMatcher.withDefaults()\n                    .matcher(adminServer.path("/login")))\n                .permitAll()\n                .requestMatchers(PathPatternRequestMatcher.withDefaults()\n                    .matcher(adminServer.path("/actuator/info")))\n                .permitAll()\n                .requestMatchers(PathPatternRequestMatcher.withDefaults()\n                    .matcher(adminServer.path("/actuator/health")))\n                .permitAll()\n                .anyRequest().authenticated()\n            )\n            .formLogin(formLogin -> formLogin\n                .loginPage(adminServer.path("/login"))\n                .successHandler(successHandler)\n            )\n            .logout(logout -> logout\n                .logoutUrl(adminServer.path("/logout"))\n            )\n            .httpBasic(Customizer.withDefaults());\n\n        http.addFilterAfter(new CustomCsrfFilter(), BasicAuthenticationFilter.class)\n            .csrf(csrf -> csrf\n                .csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse())\n                .csrfTokenRequestHandler(new CsrfTokenRequestAttributeHandler())\n                .ignoringRequestMatchers(\n                    PathPatternRequestMatcher.withDefaults()\n                        .matcher(POST, adminServer.path("/instances")),\n                    PathPatternRequestMatcher.withDefaults()\n                        .matcher(DELETE, adminServer.path("/instances/*")),\n                    PathPatternRequestMatcher.withDefaults()\n                        .matcher(adminServer.path("/actuator/**"))\n                )\n            );\n\n        http.rememberMe(rememberMe -> rememberMe\n            .key(UUID.randomUUID().toString())\n            .tokenValiditySeconds(1209600)\n        );\n\n        return http.build();\n    }\n\n    @Bean\n    public InMemoryUserDetailsManager userDetailsService(PasswordEncoder passwordEncoder) {\n        UserDetails user = User.builder()\n            .username("admin")\n            .password(passwordEncoder.encode(System.getenv("ADMIN_PASSWORD")))\n            .roles("ADMIN")\n            .build();\n\n        return new InMemoryUserDetailsManager(user);\n    }\n\n    @Bean\n    public PasswordEncoder passwordEncoder() {\n        return new BCryptPasswordEncoder();\n    }\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"CustomCsrfFilter.java"})," (same as shown earlier)."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"see-also",children:"See Also"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/4.0.0/docs/security/server-authentication",children:"Server Authentication"})," - Configure Spring Security"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"/4.0.0/docs/security/actuator-security",children:"Actuator Security"})," - Secure client endpoints"]}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://docs.spring.io/spring-security/reference/servlet/exploits/csrf.html",children:"Spring Security CSRF Documentation"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>a});var r=t(6540);const s={},i=r.createContext(s);function o(e){const n=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);